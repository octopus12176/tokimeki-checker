<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>„Å®„Åç„ÇÅ„Åç„ÉÅ„Çß„ÉÉ„Ç´„Éºüí´</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --pink: #ff6b9d;
        --yellow: #ffe14d;
        --mint: #4ecdc4;
        --coral: #ff8b6b;
        --purple: #c77dff;
        --blue: #74b9ff;
        --green: #55efc4;
        --red: #ff6b6b;
        --bg: #fff5f9;
        --white: #ffffff;
        --dark: #2d2d2d;
        --shadow: 4px 4px 0px #2d2d2d;
        --shadow-lg: 6px 6px 0px #2d2d2d;
        --shadow-sm: 2px 2px 0px #2d2d2d;
      }

      html,
      body {
        min-height: 100%;
        background: var(--bg);
        font-family: 'Zen Maru Gothic', sans-serif;
        color: var(--dark);
      }

      body::before {
        content: '';
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        background-image: radial-gradient(
            circle at 10% 20%,
            rgba(255, 107, 157, 0.08) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(78, 205, 196, 0.08) 0%,
            transparent 40%
          );
      }

      .floaties {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
      }
      .floaty {
        position: absolute;
        animation: floatAround linear infinite;
        opacity: 0.2;
        user-select: none;
      }
      @keyframes floatAround {
        0% {
          transform: translateY(0) rotate(0deg);
        }
        50% {
          transform: translateY(-28px) rotate(180deg);
        }
        100% {
          transform: translateY(0) rotate(360deg);
        }
      }

      /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        padding: 14px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--white);
        border-bottom: 3px solid var(--dark);
      }
      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: 'Nunito', sans-serif;
        font-weight: 900;
        font-size: 20px;
      }
      .logo-badge {
        background: var(--pink);
        color: white;
        padding: 4px 12px;
        border-radius: 100px;
        border: 2px solid var(--dark);
        box-shadow: var(--shadow-sm);
        font-size: 16px;
      }
      .history-pill {
        background: var(--yellow);
        border: 2px solid var(--dark);
        box-shadow: var(--shadow-sm);
        border-radius: 100px;
        padding: 8px 16px;
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .history-pill:hover {
        transform: translate(-2px, -2px);
        box-shadow: var(--shadow);
      }
      .history-pill:active {
        transform: translate(2px, 2px);
        box-shadow: none;
      }

      /* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
      #app {
        position: relative;
        z-index: 1;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 100px 20px 40px;
      }

      .screen {
        display: none;
        width: 100%;
        max-width: 560px;
      }
      .screen.active {
        display: block;
        animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }
      @keyframes popIn {
        from {
          opacity: 0;
          transform: scale(0.85) translateY(20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .card {
        background: var(--white);
        border: 3px solid var(--dark);
        border-radius: 24px;
        box-shadow: var(--shadow-lg);
        padding: 36px 32px;
        position: relative;
        overflow: hidden;
      }
      .card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 120px;
        height: 120px;
        background: var(--yellow);
        border-radius: 0 24px 0 120px;
        opacity: 0.25;
        pointer-events: none;
      }

      /* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
      .screen-title {
        font-family: 'Nunito', sans-serif;
        font-weight: 900;
        font-size: clamp(26px, 5vw, 36px);
        line-height: 1.25;
        margin-bottom: 8px;
      }
      .hl {
        background: var(--yellow);
        padding: 0 6px;
        border-radius: 6px;
      }
      .screen-subtitle {
        font-size: 14px;
        color: #888;
        margin-bottom: 28px;
        line-height: 1.7;
      }

      .field-label {
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .field-label .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--pink);
        border: 2px solid var(--dark);
      }

      input[type='text'],
      input[type='number'] {
        width: 100%;
        border: 2.5px solid var(--dark);
        border-radius: 14px;
        padding: 14px 18px;
        font-family: 'Zen Maru Gothic', sans-serif;
        font-size: 18px;
        font-weight: 700;
        color: var(--dark);
        background: var(--bg);
        outline: none;
        transition: all 0.2s;
        margin-bottom: 18px;
      }
      input:focus {
        background: white;
        box-shadow: 0 0 0 4px rgba(255, 107, 157, 0.2);
        transform: translateY(-1px);
      }
      input::placeholder {
        color: #ccc;
        font-weight: 500;
      }

      .price-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 18px;
      }
      .yen-badge {
        background: var(--mint);
        border: 2.5px solid var(--dark);
        border-radius: 12px;
        padding: 14px 16px;
        font-size: 18px;
        font-weight: 900;
        flex-shrink: 0;
        line-height: 1;
      }
      .price-row input[type='number'] {
        margin-bottom: 0;
        flex: 1;
      }

      .btn-start {
        width: 100%;
        background: var(--pink);
        color: white;
        border: 2.5px solid var(--dark);
        border-radius: 16px;
        padding: 18px;
        font-family: 'Nunito', sans-serif;
        font-weight: 900;
        font-size: 18px;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 8px;
      }
      .btn-start:hover {
        transform: translate(-2px, -2px);
        box-shadow: var(--shadow-lg);
      }
      .btn-start:active {
        transform: translate(3px, 3px);
        box-shadow: none;
      }

      /* ‚îÄ‚îÄ QUESTIONS ‚îÄ‚îÄ */
      .progress-wrap {
        margin-bottom: 24px;
      }
      .progress-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .progress-label {
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        font-size: 13px;
      }
      .progress-steps {
        display: flex;
        gap: 6px;
      }
      .step-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid var(--dark);
        background: var(--bg);
        transition: all 0.3s;
      }
      .step-dot.done {
        background: var(--pink);
      }
      .step-dot.active {
        background: var(--yellow);
        transform: scale(1.3);
      }
      .progress-bar {
        height: 10px;
        background: var(--bg);
        border: 2px solid var(--dark);
        border-radius: 100px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--pink), var(--purple));
        border-radius: 100px;
        transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .q-item-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--yellow);
        border: 2px solid var(--dark);
        border-radius: 100px;
        padding: 6px 14px;
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-sm);
      }

      /* Special chip for activism question */
      .q-item-chip.activism {
        background: #1a1a2e;
        color: white;
        border-color: #1a1a2e;
        animation: chipGlow 2s ease-in-out infinite;
      }
      @keyframes chipGlow {
        0%,
        100% {
          box-shadow: var(--shadow-sm);
        }
        50% {
          box-shadow: 2px 2px 0 #1a1a2e, 0 0 16px rgba(199, 125, 255, 0.4);
        }
      }

      .q-theme-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        padding: 4px 10px;
        border-radius: 100px;
        border: 2px solid var(--dark);
        margin-bottom: 12px;
      }

      .q-text {
        font-family: 'Nunito', sans-serif;
        font-weight: 900;
        font-size: clamp(19px, 3.5vw, 25px);
        line-height: 1.45;
        margin-bottom: 8px;
      }
      .q-sub {
        font-size: 13px;
        color: #999;
        margin-bottom: 24px;
        line-height: 1.7;
      }

      /* Activism question styles */
      .activism-card {
        background: #1a1a2e !important;
        color: white !important;
      }
      .activism-card::before {
        background: #c77dff !important;
        opacity: 0.15 !important;
      }
      .activism-card .q-text {
        color: white;
      }
      .activism-card .q-sub {
        color: rgba(255, 255, 255, 0.6);
      }
      .activism-card .progress-label {
        color: rgba(255, 255, 255, 0.8);
      }
      .activism-card .progress-bar {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
      }
      .activism-card .step-dot {
        border-color: rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.05);
      }
      .activism-card .step-dot.done {
        background: var(--purple);
        border-color: var(--purple);
      }
      .activism-card .step-dot.active {
        background: var(--yellow);
        border-color: var(--yellow);
      }

      .q-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .opt-btn {
        background: var(--white);
        border: 2.5px solid var(--dark);
        border-radius: 18px;
        padding: 18px 14px;
        cursor: pointer;
        transition: all 0.15s;
        text-align: center;
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
      }
      .opt-btn::before {
        content: '';
        position: absolute;
        inset: 0;
        background: var(--opt-color, var(--pink));
        opacity: 0;
        transition: opacity 0.2s;
      }
      .opt-btn:hover {
        transform: translate(-2px, -2px);
        box-shadow: var(--shadow);
      }
      .opt-btn:hover::before {
        opacity: 0.1;
      }
      .opt-btn.selected {
        transform: translate(-2px, -2px);
        box-shadow: var(--shadow);
        border-color: var(--opt-color, var(--pink));
      }
      .opt-btn.selected::before {
        opacity: 0.2;
      }
      .opt-btn:active {
        transform: translate(2px, 2px);
        box-shadow: none;
      }
      .opt-btn:disabled {
        cursor: default;
      }

      /* Activism option buttons */
      .activism-card .opt-btn {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.15);
        color: white;
      }
      .activism-card .opt-btn .opt-sub {
        color: rgba(255, 255, 255, 0.5);
      }
      .activism-card .opt-btn:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.4);
      }
      .activism-card .opt-btn.selected {
        border-color: var(--purple);
        background: rgba(199, 125, 255, 0.2);
      }

      .opt-icon {
        font-size: 30px;
        margin-bottom: 8px;
        display: block;
        position: relative;
        z-index: 1;
      }
      .opt-label {
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        font-size: 13px;
        display: block;
        margin-bottom: 4px;
        position: relative;
        z-index: 1;
        line-height: 1.3;
      }
      .opt-sub {
        font-size: 11px;
        color: #999;
        display: block;
        line-height: 1.4;
        position: relative;
        z-index: 1;
      }

      /* ‚îÄ‚îÄ FEEDBACK BUBBLE ‚îÄ‚îÄ */
      .feedback-bubble {
        margin-top: 18px;
        border-radius: 18px;
        padding: 14px 18px;
        font-size: 14px;
        font-weight: 700;
        line-height: 1.6;
        box-shadow: var(--shadow-sm);
        display: flex;
        align-items: center;
        gap: 10px;
        animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        min-height: 52px;
        background: linear-gradient(135deg, #fff0f6, #f0f8ff);
        border: 2.5px solid var(--dark);
      }
      .activism-card .feedback-bubble {
        background: rgba(199, 125, 255, 0.15);
        border-color: var(--purple);
        color: white;
      }
      .feedback-bubble .fb-icon {
        font-size: 20px;
        flex-shrink: 0;
      }
      .feedback-bubble .fb-text {
        flex: 1;
      }
      .feedback-loading {
        display: flex;
        gap: 5px;
        align-items: center;
      }
      .feedback-loading span {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        border: 2px solid currentColor;
        animation: bounce 0.9s ease-in-out infinite;
      }
      .feedback-loading span:nth-child(1) {
        background: var(--pink);
      }
      .feedback-loading span:nth-child(2) {
        background: var(--yellow);
        animation-delay: 0.15s;
      }
      .feedback-loading span:nth-child(3) {
        background: var(--mint);
        animation-delay: 0.3s;
      }

      .btn-next {
        width: 100%;
        background: var(--dark);
        color: white;
        border: 2.5px solid var(--dark);
        border-radius: 14px;
        padding: 16px;
        font-family: 'Nunito', sans-serif;
        font-weight: 900;
        font-size: 16px;
        cursor: pointer;
        box-shadow: var(--shadow-sm);
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 16px;
      }
      .btn-next:hover {
        transform: translate(-2px, -2px);
        box-shadow: var(--shadow);
        background: #444;
      }
      .btn-next:active {
        transform: translate(2px, 2px);
        box-shadow: none;
      }
      .btn-next:disabled {
        opacity: 0.4;
        cursor: default;
        transform: none;
        box-shadow: var(--shadow-sm);
      }

      /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
      .loading-card {
        text-align: center;
        padding: 60px 32px;
      }
      .loading-blob {
        width: 100px;
        height: 100px;
        margin: 0 auto 28px;
        background: linear-gradient(135deg, var(--pink), var(--purple));
        border-radius: 50%;
        border: 3px solid var(--dark);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 44px;
        animation: blobPulse 1.2s ease-in-out infinite;
        box-shadow: var(--shadow);
      }
      @keyframes blobPulse {
        0%,
        100% {
          transform: scale(1);
          border-radius: 50%;
        }
        33% {
          transform: scale(1.08);
          border-radius: 40% 60% 55% 45%;
        }
        66% {
          transform: scale(0.95);
          border-radius: 55% 45% 40% 60%;
        }
      }
      .loading-text {
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        font-size: 18px;
        margin-bottom: 8px;
      }
      .loading-sub {
        font-size: 13px;
        color: #aaa;
      }
      .loading-dots {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 20px;
      }
      .loading-dots span {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid var(--dark);
        animation: bounce 1s ease-in-out infinite;
      }
      .loading-dots span:nth-child(1) {
        background: var(--pink);
      }
      .loading-dots span:nth-child(2) {
        background: var(--yellow);
        animation-delay: 0.15s;
      }
      .loading-dots span:nth-child(3) {
        background: var(--mint);
        animation-delay: 0.3s;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      /* ‚îÄ‚îÄ RESULT ‚îÄ‚îÄ */
      .result-header {
        text-align: center;
        margin-bottom: 28px;
      }
      .result-emoji-wrap {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 16px;
      }
      .result-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid var(--dark);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 52px;
        box-shadow: var(--shadow-lg);
        animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }
      .result-circle.buy {
        background: linear-gradient(135deg, var(--green), var(--mint));
      }
      .result-circle.wait {
        background: linear-gradient(135deg, var(--yellow), var(--coral));
      }
      .result-circle.skip {
        background: linear-gradient(135deg, #ffb3c6, var(--pink));
      }

      .confetti-bits {
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        pointer-events: none;
      }
      .confetti-bit {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 2px;
        border: 2px solid var(--dark);
        animation: confettiFly 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        animation-delay: var(--delay, 0s);
        opacity: 0;
      }
      @keyframes confettiFly {
        0% {
          transform: translate(50%, 50%) rotate(0deg) scale(0);
          opacity: 1;
        }
        100% {
          transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(1);
          opacity: 0;
        }
      }

      .result-score-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--dark);
        color: white;
        padding: 6px 16px;
        border-radius: 100px;
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        font-size: 14px;
        margin-bottom: 12px;
      }
      .result-verdict {
        font-family: 'Nunito', sans-serif;
        font-weight: 900;
        font-size: clamp(28px, 5vw, 40px);
        line-height: 1.2;
        margin-bottom: 10px;
      }
      .result-verdict.buy {
        color: #00a86b;
      }
      .result-verdict.wait {
        color: #e67e00;
      }
      .result-verdict.skip {
        color: var(--pink);
      }
      .result-desc {
        font-size: 14px;
        color: #777;
        line-height: 1.8;
        margin-bottom: 28px;
      }

      /* Timeline */
      .timeline-title {
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 16px;
        color: #aaa;
      }
      .timeline {
        display: flex;
        flex-direction: column;
        gap: 0;
        margin-bottom: 24px;
        position: relative;
      }
      .timeline::before {
        content: '';
        position: absolute;
        left: 18px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: repeating-linear-gradient(
          to bottom,
          var(--dark) 0,
          var(--dark) 4px,
          transparent 4px,
          transparent 8px
        );
        opacity: 0.12;
      }

      .tl-item {
        display: flex;
        gap: 14px;
        align-items: flex-start;
        padding: 10px 0;
      }
      .tl-dot {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 2.5px solid var(--dark);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
        background: var(--white);
        box-shadow: var(--shadow-sm);
        z-index: 1;
      }
      .tl-dot.positive {
        background: #e8fdf2;
      }
      .tl-dot.negative {
        background: #fff0f0;
      }
      .tl-dot.neutral {
        background: #fffde8;
      }
      .tl-dot.activism {
        background: #1a1a2e;
        font-size: 14px;
        border-color: #1a1a2e;
      }

      .tl-body {
        flex: 1;
        padding-top: 4px;
      }
      .tl-q {
        font-size: 11px;
        color: #bbb;
        margin-bottom: 3px;
      }
      .tl-a {
        font-weight: 700;
        font-size: 13px;
        margin-bottom: 5px;
      }
      .tl-fb {
        font-size: 13px;
        color: #555;
        line-height: 1.6;
        background: var(--bg);
        border: 1.5px solid #eee;
        border-radius: 10px;
        padding: 8px 12px;
      }

      .btn-reset {
        width: 100%;
        background: var(--yellow);
        color: var(--dark);
        border: 2.5px solid var(--dark);
        border-radius: 16px;
        padding: 16px;
        font-family: 'Nunito', sans-serif;
        font-weight: 900;
        font-size: 16px;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .btn-reset:hover {
        transform: translate(-2px, -2px);
        box-shadow: var(--shadow-lg);
      }
      .btn-reset:active {
        transform: translate(3px, 3px);
        box-shadow: none;
      }

      /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(45, 45, 45, 0.6);
        z-index: 200;
        align-items: flex-end;
        justify-content: center;
      }
      .modal-overlay.open {
        display: flex;
      }
      .modal {
        background: var(--white);
        border: 3px solid var(--dark);
        border-radius: 28px 28px 0 0;
        padding: 28px;
        width: 100%;
        max-width: 560px;
        max-height: 70vh;
        overflow-y: auto;
        box-shadow: 0 -6px 0 var(--dark);
        animation: slideUp 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      @keyframes slideUp {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }
      .modal-handle {
        width: 40px;
        height: 5px;
        background: var(--dark);
        border-radius: 100px;
        margin: 0 auto 20px;
      }
      .modal-title {
        font-family: 'Nunito', sans-serif;
        font-weight: 900;
        font-size: 20px;
        margin-bottom: 20px;
      }
      .hist-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        border-bottom: 2px dashed #eee;
      }
      .hist-item:last-child {
        border-bottom: none;
      }
      .hist-name {
        font-weight: 700;
        font-size: 15px;
      }
      .hist-meta {
        font-size: 12px;
        color: #bbb;
        margin-top: 3px;
      }
      .hist-badge {
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        font-size: 12px;
        padding: 5px 12px;
        border-radius: 100px;
        border: 2px solid var(--dark);
        white-space: nowrap;
      }
      .hist-badge.buy {
        background: var(--green);
      }
      .hist-badge.wait {
        background: var(--yellow);
      }
      .hist-badge.skip {
        background: #ffb3c6;
      }
      .empty-hist {
        text-align: center;
        color: #ccc;
        font-size: 14px;
        padding: 40px 0;
      }
      .modal-close-btn {
        width: 100%;
        background: var(--bg);
        border: 2px solid var(--dark);
        border-radius: 12px;
        padding: 12px;
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        font-size: 14px;
        cursor: pointer;
        margin-top: 16px;
        transition: all 0.15s;
      }
      .modal-close-btn:hover {
        background: var(--dark);
        color: white;
      }

      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--pink);
        border-radius: 100px;
      }
    </style>
  </head>
  <body>
    <div class="floaties" id="floaties"></div>

    <header class="header">
      <div class="logo">
        <span class="logo-badge">‚ú®</span>„Å®„Åç„ÇÅ„Åç„ÉÅ„Çß„ÉÉ„Ç´„Éº
      </div>
      <button class="history-pill" onclick="openHistory()">üìã Â±•Ê≠¥</button>
    </header>

    <div id="app">
      <!-- Screen 1: Input -->
      <div class="screen active" id="screen-input">
        <div class="card">
          <div class="screen-title">
            Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„ÄÅ<br /><span class="hl">Êú¨Èü≥„Åß</span>„ÉÅ„Çß„ÉÉ„ÇØÔºÅüîç
          </div>
          <p class="screen-subtitle">
            6„Å§„ÅÆË¶ñÁÇπ„Åã„Çâ„ÅÇ„Å™„Åü„ÅÆË≥ºË≤∑Ë°ùÂãï„ÇíÂàÜÊûê„Åó„Åæ„Åô„ÄÇ<br />
            „Å®„Åç„ÇÅ„Åç„ÉªÂøÖË¶ÅÊÄß„Éª‰ª£ÊõøÊâãÊÆµ„ÉªÁ§æ‰ºö„ÅÆÁõÆÁ∑ö„Åæ„Åß„ÄÇ
          </p>
          <div class="field-label"><span class="dot"></span>Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ</div>
          <input
            type="text"
            id="item-name"
            placeholder="‰æãÔºö„ÉØ„Ç§„É§„É¨„Çπ„Ç§„É§„Éõ„É≥ üéß"
            maxlength="40"
          />
          <div class="field-label">
            <span class="dot" style="background: var(--mint)"></span
            >„ÅäÂÄ§ÊÆµÔºàÁúÅÁï•OKÔºâ
          </div>
          <div class="price-row">
            <span class="yen-badge">¬•</span>
            <input type="number" id="item-price" placeholder="0" min="0" />
          </div>
          <button class="btn-start" onclick="startCheck()">
            „ÉÅ„Çß„ÉÉ„ÇØ„Çπ„Çø„Éº„ÉàÔºÅ üöÄ
          </button>
        </div>
      </div>

      <!-- Screen 2: Questions -->
      <div class="screen" id="screen-questions">
        <div class="card" id="q-card">
          <div class="progress-wrap">
            <div class="progress-meta">
              <span class="progress-label" id="q-number-label"></span>
              <div class="progress-steps" id="step-dots"></div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
          </div>
          <div class="q-item-chip" id="q-chip">
            üõçÔ∏è <span id="q-chip-name"></span>
          </div>
          <div class="q-theme-tag" id="q-theme-tag"></div>
          <div class="q-text" id="q-text"></div>
          <div class="q-sub" id="q-sub"></div>
          <div class="q-options" id="q-options"></div>
          <div
            class="feedback-bubble"
            id="feedback-bubble"
            style="display: none"
          >
            <span class="fb-icon">ü§ñ</span>
            <span class="fb-text" id="fb-text">
              <span class="feedback-loading"
                ><span></span><span></span><span></span
              ></span>
            </span>
          </div>
          <button
            class="btn-next"
            id="btn-next"
            onclick="nextQuestion()"
            disabled
            style="display: none"
          >
            Ê¨°„ÅÆË≥™Âïè„Å∏ ‚Üí
          </button>
        </div>
      </div>

      <!-- Screen 3: Loading -->
      <div class="screen" id="screen-loading">
        <div class="card loading-card">
          <div class="loading-blob">üîÆ</div>
          <div class="loading-text">ÊúÄÁµÇÂà§ÂÆö„ÇíÁîüÊàê‰∏≠‚Ä¶ÔºÅ</div>
          <div class="loading-sub">AI„Åå6„Å§„ÅÆË¶ñÁÇπ„Åã„ÇâÁ∑èÂêàÁöÑ„Å´ÂàÜÊûê„Åó„Å¶„ÅÑ„Åæ„Åô</div>
          <div class="loading-dots">
            <span></span><span></span><span></span>
          </div>
        </div>
      </div>

      <!-- Screen 4: Result -->
      <div class="screen" id="screen-result">
        <div class="card">
          <div class="result-header">
            <div class="result-emoji-wrap">
              <div class="result-circle" id="result-circle"></div>
              <div class="confetti-bits" id="confetti-container"></div>
            </div>
            <div class="result-score-badge" id="result-score"></div>
            <div class="result-verdict" id="result-verdict"></div>
            <p class="result-desc" id="result-desc"></p>
          </div>
          <div class="timeline-title">üìù 6„Å§„ÅÆË¶ñÁÇπ„Åã„Çâ„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ</div>
          <div class="timeline" id="timeline"></div>
          <button class="btn-reset" onclick="resetApp()">
            üîÅ „ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã
          </button>
        </div>
      </div>
    </div>

    <div
      class="modal-overlay"
      id="modal-overlay"
      onclick="handleOverlayClick(event)"
    >
      <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-title">üìã „ÉÅ„Çß„ÉÉ„ÇØÂ±•Ê≠¥</div>
        <div id="history-list"></div>
        <button class="modal-close-btn" onclick="closeHistory()">Èñâ„Åò„Çã</button>
      </div>
    </div>

    <script>
      // ‚îÄ‚îÄ Floaties ‚îÄ‚îÄ
      [
        '‚ú®',
        'üí´',
        '‚≠ê',
        'üåü',
        'üíñ',
        'üõçÔ∏è',
        'üí∏',
        'üåà',
        'üéÄ',
        'üíù',
        'üå∏',
        'üç≠',
      ].forEach((em) => {
        const el = document.createElement('div');
        el.className = 'floaty';
        el.textContent = em;
        el.style.cssText = `left:${Math.random() * 90}%;top:${
          Math.random() * 90
        }%;animation-duration:${6 + Math.random() * 8}s;animation-delay:${
          Math.random() * 5
        }s;font-size:${18 + Math.random() * 18}px;`;
        document.getElementById('floaties').appendChild(el);
      });

      // ‚îÄ‚îÄ Questions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const questions = [
        {
          theme: 'tokimeki',
          themeLabel: 'üíñ „Å®„Åç„ÇÅ„Åç',
          themeColor: 'var(--pink)',
          text: '‰ªä„Åì„ÅÆÁû¨Èñì„ÄÅÂøÉ„Åã„Çâ„Å®„Åç„ÇÅ„ÅÑ„Å¶„ÅÑ„ÇãÔºüüíñ',
          sub: '„ÄåË¶ã„ÅüÁû¨Èñì„Å´Ê¨≤„Åó„Åè„Å™„Å£„Åü„Äç„ÅÆ„Åã„Äå„Å™„Çì„Å®„Å™„ÅèÊ∞ó„Å´„Å™„Å£„Å¶„Çã„Äç„ÅÆ„Åã„ÄÅÊ≠£Áõ¥„Å´„ÄÇ',
          options: [
            {
              icon: '‚ú®',
              label: 'Âº∑„Åè„Å®„Åç„ÇÅ„Åè',
              sub: 'Ë¶ã„Çã„Åü„Å≥„Å´ÂøÉ„ÅåË∫ç„Çã',
              score: 3,
              color: 'var(--pink)',
            },
            {
              icon: 'üòä',
              label: '„Åæ„ÅÇÂ•Ω„Åç',
              sub: '„ÅÇ„Å£„Åü„ÇâÂ¨â„Åó„ÅÑ„Å™Á®ãÂ∫¶',
              score: 1,
              color: 'var(--blue)',
            },
            {
              icon: 'ü§î',
              label: '„Å™„Çì„Å®„Å™„ÅèÊ¨≤„Åó„ÅÑ',
              sub: 'Ë™∞„Åã„ÅåÊåÅ„Å£„Å¶„Åü„Åã„ÇâÊ∞ó„Å´„Å™„Å£„Åü',
              score: -1,
              color: 'var(--yellow)',
            },
            {
              icon: 'üòê',
              label: '„Çà„Åè„Çè„Åã„Çâ„Å™„ÅÑ',
              sub: '„Å™„ÅúÊ¨≤„Åó„ÅÑ„ÅãË®Ä„Åà„Å™„ÅÑ',
              score: -2,
              color: 'var(--purple)',
            },
          ],
        },
        {
          theme: 'mise',
          themeLabel: 'üëÅÔ∏è Ë¶ãÊ†Ñ„ÉÅ„Çß„ÉÉ„ÇØ',
          themeColor: 'var(--coral)',
          text: 'Ê≠£Áõ¥„Å´Ë®Ä„Å£„Å¶„ÄÅË™∞„Åã„Å´Ë¶ã„Åõ„Åü„ÅÑÊ∞óÊåÅ„Å°„ÅØ„ÅÇ„ÇãÔºüüëÅÔ∏è',
          sub: '„ÄåÊåÅ„Å£„Å¶„Åü„Çâ„Ç´„ÉÉ„Ç≥„ÅÑ„ÅÑ„Äç„Äå„Äá„Äá„Åï„Çì„ÅåÊåÅ„Å£„Å¶„Åü„Äç„Å®„ÅÑ„ÅÜÂãïÊ©ü„ÅØ„Å™„ÅÑ„ÅãËá™Âïè„Åó„Å¶„Åø„Å¶„ÄÇ',
          options: [
            {
              icon: 'üôÖ',
              label: 'ÂÖ®„Åè„Å™„ÅÑ',
              sub: 'Á¥îÁ≤ã„Å´Ëá™ÂàÜ„ÅÆ„Åü„ÇÅ„Å´Ê¨≤„Åó„ÅÑ',
              score: 3,
              color: 'var(--mint)',
            },
            {
              icon: 'ü§è',
              label: 'Â∞ë„Åó„ÅØ„ÅÇ„Çã',
              sub: '„Åß„ÇÇÊú¨Ë≥™„ÅØËá™ÂàÜÁî®',
              score: 1,
              color: 'var(--blue)',
            },
            {
              icon: 'üëÄ',
              label: '„Åë„Å£„Åì„ÅÜ„ÅÇ„Çã',
              sub: 'Ë™∞„Åã„Å´Ë¶ã„Åõ„Åü„ÅÑÊ∞óÊåÅ„Å°„ÅåÂº∑„ÇÅ',
              score: -2,
              color: 'var(--yellow)',
            },
            {
              icon: 'üèÜ',
              label: '„Åù„Çå„Åå‰∏ª„Å™ÁêÜÁî±',
              sub: 'ÊâøË™ç„Åï„Çå„Åü„Åè„Å¶Ê¨≤„Åó„ÅÑ',
              score: -3,
              color: 'var(--coral)',
            },
          ],
        },
        {
          theme: 'hitsuyou',
          themeLabel: 'üéØ ÂøÖË¶ÅÊÄß',
          themeColor: 'var(--blue)',
          text: '„Åù„Çå„ÇíË≤∑„ÅÜ„ÄÅÂÖ∑‰ΩìÁöÑ„Å™ÁêÜÁî±„ÇíË®Ä„Åà„ÇãÔºüüéØ',
          sub: '„Äå„Å™„ÅúÂøÖË¶Å„Å™„ÅÆ„Åã„Äç„Çí30Áßí„ÅßË™¨Êòé„Åß„Åç„Çå„Å∞Êú¨Áâ©„ÅÆÂøÖË¶ÅÊÄß„ÄÇË™¨Êòé„Åß„Åç„Å™„ÅÑ„Å™„ÇâË°ùÂãï„Åã„ÇÇ„ÄÇ',
          options: [
            {
              icon: 'üîß',
              label: 'ÊòéÁ¢∫„Å´Ë™¨Êòé„Åß„Åç„Çã',
              sub: 'ÂÖ∑‰ΩìÁöÑ„Å™Áî®ÈÄî„ÉªÂ†¥Èù¢„Åå„ÅÇ„Çã',
              score: 3,
              color: 'var(--mint)',
            },
            {
              icon: 'üìù',
              label: '„Å†„ÅÑ„Åü„ÅÑË®Ä„Åà„Çã',
              sub: '„Åµ„Çì„Çè„Çä„Å®„Åó„ÅüÁêÜÁî±„ÅØ„ÅÇ„Çã',
              score: 1,
              color: 'var(--blue)',
            },
            {
              icon: 'üåÄ',
              label: '„ÅÇ„Åæ„ÇäË®Ä„Åà„Å™„ÅÑ',
              sub: '„Å™„Çì„Å®„Å™„ÅèÊ¨≤„Åó„ÅÑ„ÅåÂÖà„Å´„ÅÇ„Çã',
              score: -2,
              color: 'var(--yellow)',
            },
            {
              icon: '‚ùì',
              label: 'Ë®Ä„Åà„Å™„ÅÑ',
              sub: 'Ê∞ó„Å•„ÅÑ„Åü„ÇâÊ¨≤„Åó„Åè„Å™„Å£„Å¶„Åü',
              score: -3,
              color: 'var(--coral)',
            },
          ],
        },
        {
          theme: 'tsukauka',
          themeLabel: 'üìÖ ‰Ωø„ÅÑÁ∂ö„Åë„Çã„Åã',
          themeColor: 'var(--green)',
          text: '3„É∂ÊúàÂæå„ÇÇ‰Ωø„Å£„Å¶„ÅÑ„ÇãËá™ÂàÜ„ÅåÊÉ≥ÂÉè„Åß„Åç„ÇãÔºüüìÖ',
          sub: '„ÄåË≤∑„Å£„ÅüÁõ¥Âæå„Å†„Åë‰Ωø„Å£„Å¶ÊîæÁΩÆ„Äç„Å®„ÅÑ„ÅÜÈÅéÂéª„ÅÆ„Éë„Çø„Éº„É≥„Å´Ê≠£Áõ¥„Å´Âêë„ÅçÂêà„Å£„Å¶„ÄÇ',
          options: [
            {
              icon: 'üí™',
              label: 'Áµ∂ÂØæ‰Ωø„Å£„Å¶„Çã',
              sub: 'ÊØéÊó•„ÅÆÁîüÊ¥ª„Å´ÁµÑ„ÅøËæº„ÇÅ„Çã',
              score: 3,
              color: 'var(--mint)',
            },
            {
              icon: 'üôÇ',
              label: '„Åü„Å∂„Çì‰Ωø„Å£„Å¶„Çã',
              sub: 'ÈÄ±„Å´Êï∞Âõû„ÅØ‰Ωø„ÅÜ„ÅØ„Åö',
              score: 1,
              color: 'var(--blue)',
            },
            {
              icon: 'üòÖ',
              label: 'Ëá™‰ø°„Åå„Å™„ÅÑ',
              sub: 'È£Ω„Åç„ÇÑ„Åô„ÅÑ„Çø„Ç§„Éó„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ',
              score: -2,
              color: 'var(--yellow)',
            },
            {
              icon: 'üì¶',
              label: '„Åü„Å∂„ÇìÊîæÁΩÆ„Åô„Çã',
              sub: '‰ºº„Åü„ÇÇ„ÅÆ„Åå„Åô„Åß„Å´Áú†„Å£„Å¶„Çã',
              score: -3,
              color: 'var(--coral)',
            },
          ],
        },
        {
          theme: 'daigae',
          themeLabel: '‚ôªÔ∏è ‰ª£ÊõøÊâãÊÆµ',
          themeColor: 'var(--mint)',
          text: '„ÇÇ„Å£„Å®ÂÆâ„Åè„ÉªÁÑ°Êñô„ÅßÊâã„Å´ÂÖ•„Çå„ÇãÊñπÊ≥ï„ÅØ„Å™„ÅÑÔºü‚ôªÔ∏è',
          sub: 'Êú¨„Å™„ÇâÂõ≥Êõ∏È§®„Éª„Éñ„ÉÉ„ÇØ„Ç™„Éï„ÄÇÈü≥Ê•Ω„Å™„Çâ„Çµ„Éñ„Çπ„ÇØ„ÄÇÈ£üÂìÅ„Å™„ÇâËá™ÁÇä„ÄÇ„Ç≥„Éº„Éí„Éº„Å™„Çâ„Éâ„É™„ÉÉ„Éó„Éê„ÉÉ„Ç∞„ÄÇÊú¨ÂΩì„Å´„ÄåË≤∑„ÅÜ„Äç„Åó„Åã„Å™„ÅÑ„ÅãÔºü',
          options: [
            {
              icon: 'üö´',
              label: '‰ª£ÊõøÊâãÊÆµ„ÅØ„Å™„ÅÑ',
              sub: '„Åì„Çå‰ª•Â§ñ„Å´ÊñπÊ≥ï„Åå„Å™„ÅÑ',
              score: 3,
              color: 'var(--mint)',
            },
            {
              icon: 'üîç',
              label: 'Êé¢„Åõ„Å∞„ÅÇ„Çã„Åã„ÇÇ',
              sub: '„Åæ„Å†„Å°„ÇÉ„Çì„Å®Ë™ø„Åπ„Å¶„ÅÑ„Å™„ÅÑ',
              score: -1,
              color: 'var(--yellow)',
            },
            {
              icon: 'üìö',
              label: '‰ª£ÊõøÊâãÊÆµ„Åå„ÅÇ„Çã',
              sub: '„Åß„ÇÇË≤∑„ÅÜÊñπ„Åå‰æøÂà©„ÉªÂø´ÈÅ©',
              score: -1,
              color: 'var(--blue)',
            },
            {
              icon: 'üí°',
              label: '‰ª£ÊõøÊâãÊÆµ„ÅßÂçÅÂàÜ',
              sub: 'Ê≠£Áõ¥„ÄÅ„Åù„Å£„Å°„Åß„ÅÑ„ÅÑÊ∞ó„ÇÇ„Åô„Çã',
              score: -3,
              color: 'var(--coral)',
            },
          ],
        },
        {
          theme: 'shihonshugi',
          themeLabel: 'üåç Ê∂àË≤ª„ÇíÂïè„ÅÑÁõ¥„Åô',
          themeColor: '#C77DFF',
          text: '„Åù„ÅÆÊ¨≤Ê±Ç„ÄÅÊú¨ÂΩì„Å´„ÄåËá™ÂàÜ„ÅÆÊÑèÂøó„Äç„Åã„ÇâÊù•„Å¶„ÇãÔºüüåç',
          sub: 'Â∫ÉÂëä„ÉªSNS„Éª„Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„Éº„ÉªÊµÅË°å„Éª„Äå„Åø„Çì„Å™ÊåÅ„Å£„Å¶„Çã„ÄçÁ©∫Ê∞ó„Å´ÁÑ°ÊÑèË≠ò„Å´‰πó„Åõ„Çâ„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÄÇË≥áÊú¨‰∏ªÁæ©„ÅØÁßÅ„Åü„Å°„Å´„ÄåÊ¨≤„Åó„ÅÑ„Äç„Å®ÊÑü„Åò„Åï„Åõ„Çã„ÅÆ„Åå„Å®„Å¶„ÇÇ‰∏äÊâã„ÅÑ„ÄÇ',
          options: [
            {
              icon: 'üß†',
              label: 'Ëá™ÂàÜ„ÅÆÊÑèÂøó„ÅßÊ¨≤„Åó„ÅÑ',
              sub: 'Â∫ÉÂëä„ÇÑÊµÅË°å„Å®„ÅØÈñ¢‰øÇ„Å™„ÅÑ',
              score: 3,
              color: '#C77DFF',
            },
            {
              icon: 'ü§∑',
              label: 'Â∞ë„ÅóÂΩ±Èüø„ÅØ„ÅÇ„Çã',
              sub: 'SNS„ÅßË¶ã„Å¶„Åã„ÇâÊ∞ó„Å´„Å™„Å£„Åü',
              score: 0,
              color: '#74B9FF',
            },
            {
              icon: 'üì±',
              label: 'SNS„ÉªÂ∫ÉÂëä„Åå„Åç„Å£„Åã„Åë',
              sub: 'Ë¶ã„Å™„Åë„Çå„Å∞Ê¨≤„Åó„Åè„Å™„Åã„Å£„Åü„Åã„ÇÇ',
              score: -2,
              color: '#FFE14D',
            },
            {
              icon: 'üè≠',
              label: 'ÂÆåÂÖ®„Å´ÊµÅË°å„Å´‰πó„Å£„Å¶„Çã',
              sub: 'Ë≥áÊú¨‰∏ªÁæ©„ÅÆÊÄù„ÅÜ„ÉÑ„Éú„Åã„ÇÇ',
              score: -3,
              color: '#FF8B6B',
            },
          ],
        },
      ];

      // ‚îÄ‚îÄ State ‚îÄ‚îÄ
      let currentQ = 0,
        scores = [],
        feedbacks = [],
        answers = [];
      let itemName = '',
        itemPrice = '';
      let history = [];
      try {
        history = JSON.parse(localStorage.getItem('tokimeki_history') || '[]');
      } catch (e) {}

      // ‚îÄ‚îÄ Screen ‚îÄ‚îÄ
      function showScreen(id) {
        document
          .querySelectorAll('.screen')
          .forEach((s) => s.classList.remove('active'));
        setTimeout(() => {
          const el = document.getElementById(id);
          if (el) el.classList.add('active');
        }, 30);
      }

      function startCheck() {
        itemName =
          document.getElementById('item-name').value.trim() || '„Åì„ÅÆÂïÜÂìÅ';
        itemPrice = document.getElementById('item-price').value;
        currentQ = 0;
        scores = [];
        feedbacks = [];
        answers = [];
        showScreen('screen-questions');
        renderQ();
      }

      function renderQ() {
        const q = questions[currentQ];
        const total = questions.length;
        const isActivism = q.theme === 'shihonshugi';

        // Card theme
        const card = document.getElementById('q-card');
        card.className = isActivism ? 'card activism-card' : 'card';

        // Chip
        const chip = document.getElementById('q-chip');
        chip.className = isActivism ? 'q-item-chip activism' : 'q-item-chip';
        document.getElementById('q-chip-name').textContent = itemName;

        // Progress
        document.getElementById('progress-fill').style.width =
          (currentQ / total) * 100 + '%';
        document.getElementById('q-number-label').textContent = `Ë≥™Âïè ${
          currentQ + 1
        } / ${total}`;

        // Step dots
        const dotsEl = document.getElementById('step-dots');
        dotsEl.innerHTML = '';
        for (let i = 0; i < total; i++) {
          const d = document.createElement('div');
          d.className =
            'step-dot' +
            (i < currentQ ? ' done' : i === currentQ ? ' active' : '');
          dotsEl.appendChild(d);
        }

        // Theme tag
        const tag = document.getElementById('q-theme-tag');
        tag.textContent = q.themeLabel;
        tag.style.background = isActivism
          ? 'rgba(199,125,255,.2)'
          : q.themeColor + '33';
        tag.style.borderColor = isActivism ? '#C77DFF' : q.themeColor;
        tag.style.color = isActivism
          ? '#C77DFF'
          : q.themeColor === 'var(--yellow)'
          ? '#b89300'
          : q.themeColor;

        document.getElementById('q-text').textContent = q.text;
        document.getElementById('q-sub').textContent = q.sub;

        // Options
        const optsEl = document.getElementById('q-options');
        optsEl.innerHTML = '';
        q.options.forEach((opt) => {
          const btn = document.createElement('button');
          btn.className = 'opt-btn';
          btn.style.setProperty('--opt-color', opt.color);
          btn.innerHTML = `<span class="opt-icon">${opt.icon}</span><span class="opt-label">${opt.label}</span><span class="opt-sub">${opt.sub}</span>`;
          btn.onclick = () => pickAnswer(opt, btn);
          optsEl.appendChild(btn);
        });

        // Reset feedback + next btn
        document.getElementById('feedback-bubble').style.display = 'none';
        const btnNext = document.getElementById('btn-next');
        btnNext.style.display = 'none';
        btnNext.disabled = true;
        btnNext.textContent =
          currentQ < questions.length - 1 ? 'Ê¨°„ÅÆË≥™Âïè„Å∏ ‚Üí' : 'ÁµêÊûú„ÇíË¶ã„Çã üéâ';
      }

      async function pickAnswer(opt, btn) {
        document.querySelectorAll('.opt-btn').forEach((b) => {
          b.disabled = true;
          b.classList.remove('selected');
        });
        btn.classList.add('selected');
        scores.push(opt.score);
        answers.push({
          theme: questions[currentQ].theme,
          themeLabel: questions[currentQ].themeLabel,
          q: questions[currentQ].text,
          a: opt.label,
          score: opt.score,
        });

        // Show loading bubble
        const bubble = document.getElementById('feedback-bubble');
        const fbText = document.getElementById('fb-text');
        bubble.style.display = 'flex';
        fbText.innerHTML =
          '<span class="feedback-loading"><span></span><span></span><span></span></span>';

        fetchFeedback(opt)
          .then((text) => {
            feedbacks.push(text);
            fbText.textContent = text;
            document.getElementById('btn-next').disabled = false;
          })
          .catch(() => {
            const fallback =
              opt.score >= 2
                ? '‚úÖ ËâØ„ÅÑ„Çµ„Ç§„É≥„Åß„ÅôÔºÅ'
                : opt.score <= -2
                ? '‚ö†Ô∏è Â∞ë„ÅóÁ´ã„Å°Ê≠¢„Åæ„Å£„Å¶„Åø„Åæ„Åó„Çá„ÅÜ'
                : 'üìä „Éê„É©„É≥„Çπ„ÅåÂ§ßÂàá„Åß„Åô„Å≠';
            feedbacks.push(fallback);
            fbText.textContent = fallback;
            document.getElementById('btn-next').disabled = false;
          });

        document.getElementById('btn-next').style.display = 'flex';
      }

      async function fetchFeedback(opt) {
        const res = await fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            itemName,
            itemPrice,
            questionText: questions[currentQ].text,
            answerText: opt.label,
            answerScore: opt.score,
            questionIndex: currentQ,
            questionTheme: questions[currentQ].theme,
          }),
        });
        if (!res.ok) throw new Error('API error');
        const data = await res.json();
        return data.feedback;
      }

      function nextQuestion() {
        currentQ++;
        if (currentQ >= questions.length) {
          showScreen('screen-loading');
          setTimeout(showResult, 1200);
        } else {
          renderQ();
        }
      }

      function showResult() {
        // Score: max possible = 3+3+3+3+3+3 = 18, min = -2-3-3-3-3-3 = -17
        const MAX = 18,
          MIN = -17;
        const total = scores.reduce((a, b) => a + b, 0);
        const pct = Math.max(0, Math.min(1, (total - MIN) / (MAX - MIN)));
        const scorePct = Math.round(pct * 100);

        let type, emoji, verdict, desc;

        if (pct >= 0.65) {
          type = 'buy';
          emoji = 'üõí';
          verdict = 'Ë≤∑„Å£„Å°„ÇÉ„Åä„ÅÜÔºÅ';
          desc = `„Äå${itemName}„Äç„ÅØ6„Å§„ÅÆË¶ñÁÇπ„Åã„Çâ„ÇÇÊú¨Áâ©„ÅÆ‰æ°ÂÄ§„Åå„ÅÇ„Çã„Å®Âá∫„Åæ„Åó„Åü„ÄÇ„Å®„Åç„ÇÅ„Åç„ÇÇÂøÖË¶ÅÊÄß„ÇÇ„ÅÇ„ÇãË≤∑„ÅÑÁâ©„Åß„Åô„ÄÇÂæåÊÇî„Åó„Å™„ÅÑ„Åß„Åó„Çá„ÅÜÔºÅ`;
        } else if (pct >= 0.4) {
          type = 'wait';
          emoji = '‚è≥';
          verdict = '„ÇÇ„ÅÜÂ∞ë„ÅóÂæÖ„Å£„Å¶';
          desc = `„Äå${itemName}„Äç„Å∏„ÅÆÊ∞óÊåÅ„Å°„ÅØ„Éù„Ç∏„ÉÜ„Ç£„Éñ„Å™Èù¢„ÇÇ„ÅÇ„Çä„Åæ„Åô„Åå„ÄÅ„ÅÑ„Åè„Å§„ÅãÂºï„Å£„Åã„Åã„ÇãÁÇπ„ÇÇ„ÅÇ„Çä„Åæ„Åô„ÄÇ1ÈÄ±ÈñìÂæå„Å´„ÇÇ„ÅÜ‰∏ÄÂ∫¶ËÄÉ„Åà„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ`;
        } else {
          type = 'skip';
          emoji = 'üåä';
          verdict = '‰ªäÂõû„ÅØË¶ãÈÄÅ„Çç„ÅÜ';
          desc = `„Äå${itemName}„Äç„Å∏„ÅÆÊ¨≤Ê±Ç„ÅØ„ÄÅÂ§ñÁöÑ„Å™Ë¶ÅÂõ†„ÇÑ‰∏ÄÊôÇÁöÑ„Å™Ë°ùÂãï„ÅåÂº∑„ÅÑ„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇÁØÄÁ¥Ñ„Åó„ÅüÂàÜ„ÇíÊú¨ÂΩì„Å´Â§ßÂàá„Å™„ÇÇ„ÅÆ„Å∏„ÄÇ`;
        }

        const circle = document.getElementById('result-circle');
        circle.className = `result-circle ${type}`;
        circle.textContent = emoji;
        if (type === 'buy') spawnConfetti();

        document.getElementById(
          'result-score'
        ).textContent = `‚≠ê „Çπ„Ç≥„Ç¢ ${scorePct}ÁÇπ / 100ÁÇπ`;
        const vEl = document.getElementById('result-verdict');
        vEl.className = `result-verdict ${type}`;
        vEl.textContent = verdict;
        document.getElementById('result-desc').textContent = desc;

        // Timeline
        const tlEl = document.getElementById('timeline');
        tlEl.innerHTML = answers
          .map((a, i) => {
            const isActivism = a.theme === 'shihonshugi';
            const cls = isActivism
              ? 'activism'
              : a.score >= 2
              ? 'positive'
              : a.score <= -2
              ? 'negative'
              : 'neutral';
            const icon = isActivism
              ? 'üåç'
              : a.score >= 2
              ? '‚úÖ'
              : a.score <= -2
              ? '‚ö†Ô∏è'
              : 'üìä';
            return `
        <div class="tl-item">
          <div class="tl-dot ${cls}">${icon}</div>
          <div class="tl-body">
            <div class="tl-q">${a.themeLabel}</div>
            <div class="tl-a">„Äå${a.a}„Äç„ÇíÈÅ∏Êäû</div>
            <div class="tl-fb">${feedbacks[i] || '‚Äî'}</div>
          </div>
        </div>`;
          })
          .join('');

        // Save history
        history.unshift({
          name: itemName,
          price: parseFloat(itemPrice) || 0,
          type,
          verdict,
          score: scorePct,
          date: new Date().toLocaleDateString('ja-JP', {
            month: 'short',
            day: 'numeric',
          }),
        });
        if (history.length > 20) history.pop();
        try {
          localStorage.setItem('tokimeki_history', JSON.stringify(history));
        } catch (e) {}

        showScreen('screen-result');
      }

      function spawnConfetti() {
        const c = document.getElementById('confetti-container');
        c.innerHTML = '';
        const colors = [
          'var(--pink)',
          'var(--yellow)',
          'var(--mint)',
          'var(--purple)',
          'var(--blue)',
        ];
        for (let i = 0; i < 12; i++) {
          const bit = document.createElement('div');
          const angle = (i / 12) * 360;
          const dist = 50 + Math.random() * 30;
          bit.className = 'confetti-bit';
          bit.style.cssText = `background:${colors[i % colors.length]};--tx:${
            Math.cos((angle * Math.PI) / 180) * dist
          }px;--ty:${Math.sin((angle * Math.PI) / 180) * dist}px;--rot:${
            Math.random() * 360
          }deg;--delay:${Math.random() * 0.3}s;top:50%;left:50%;`;
          c.appendChild(bit);
        }
      }

      function resetApp() {
        document.getElementById('item-name').value = '';
        document.getElementById('item-price').value = '';
        showScreen('screen-input');
      }

      function openHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = !history.length
          ? '<div class="empty-hist">üòä „Åæ„Å†Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'
          : history
              .map(
                (h) =>
                  `<div class="hist-item"><div><div class="hist-name">${
                    h.name
                  }</div><div class="hist-meta">${h.date}${
                    h.price ? ' ¬∑ ¬•' + h.price.toLocaleString() : ''
                  } ¬∑ ${h.score}ÁÇπ</div></div><span class="hist-badge ${
                    h.type
                  }">${h.verdict}</span></div>`
              )
              .join('');
        document.getElementById('modal-overlay').classList.add('open');
      }
      function closeHistory() {
        document.getElementById('modal-overlay').classList.remove('open');
      }
      function handleOverlayClick(e) {
        if (e.target === document.getElementById('modal-overlay'))
          closeHistory();
      }

      document.getElementById('item-name').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') startCheck();
      });
    </script>
  </body>
</html>
